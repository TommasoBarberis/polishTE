Bootstrap: debootstrap
OSVersion: focal
MirrorURL:  http://us.archive.ubuntu.com/ubuntu/
Stage: build


%post
    cd /opt

    ## install dependancies

    apt-get update
    apt-get install -y \
        wget git \
        autoconf build-essential \
        python3 \
        dirmngr gnupg apt-transport-https ca-certificates software-properties-common

    # add the CRAN repo
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9
    add-apt-repository 'deb https://cloud.r-project.org/bin/linux/ubuntu focal-cran40/'

    # mafft
    wget https://mafft.cbrc.jp/alignment/software/mafft_7.490-1_amd64.deb
    dpkg -i mafft_7.490-1_amd64.deb

    # blastn
    wget https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/2.13.0/ncbi-blast-2.13.0+-x64-linux.tar.gz
    tar -xvf ncbi-blast-2.13.0+-x64-linux.tar.gz

    # samtools dep
    wget https://github.com/samtools/htslib/archive/refs/tags/1.10.tar.gz
    tar -xvf 1.10.tar.gz
    autoheader
    autoconf -Wno-syntax
    htslib_path=$(realpath .)
    ./configure --prefix=$htslib_path
    make && make install
    cd ..

    # samtools
    wget https://github.com/samtools/samtools/archive/refs/tags/1.10.tar.gz
    tar -xvf 1.10.tar.gz
    cd samtools-1.10
    autoheader
    autoconf -Wno-syntax
    samtools_path=$(realpath .)
    ./configure --prefix=$samtools_path --with-htslib=$htslib_path
    make && make install
    cd ..

    # bedtools
    wget https://github.com/arq5x/bedtools2/releases/download/v2.30.0/bedtools.static.binary
    mv bedtools.static.binary bedtools
    chmod +x bedtools

    # pip
    wget https://bootstrap.pypa.io/get-pip.py
    python get-pip.py

    # CIAlign dep
    python -m pip install -U matplotlib==2.1.1
    python -m pip install -U numpy==1.16.3
    python -m pip install -U scipy==1.3.0

    # CIAlign
    pip3 install cialign

    # Python modules
    pip install python-Levenshtein==0.12.2

    # R
    apt install r-base

    # polishTE
    git clone https://github.com/TommasoBarberis/polishTE.git


%environment
    export PATH=/opt/:$PATH
    export PATH=/opt/ncbi-blast-2.13.0+/bin:$PATH
    export PATH=/opt/polishTE:$PATH


%help
    Container for the polishTE pipeline. For more information see: https://github.com/TommasoBarberis/polishTE.